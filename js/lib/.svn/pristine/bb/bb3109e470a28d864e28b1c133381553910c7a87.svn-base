/* Copyright (c) 2014 TreSensa, Inc. All Rights Reserved. */
TGS.Adapters.A0020=function(){TGS.Adapters.A0020.superclass.constructor.call(this),this._mLoggedIn=!1,this._mMoreGamesURL="card://kik.tresensa.com/moregames/index.html",this._mSkipBackgroundEvent=!1,TGS.DataStore._sSaveToLocalStorage=!0,TGS.DataStore._sSaveToTGSServer=!1,this._mUseUserInfoInSLB=!0,this._mKikForIAPs=!0},TGS.Adapters.A0020.prototype={supportsMicrotransactions:function(){return!0},autoLogin:function(){return!1},supportsLogout:function(){return!1},loginIcon:function(){return TGS._IMAGES_LOCATION+"kik_login.png"},supportsChallenges:function(){return!0},challengeIcon:function(){return TGS._IMAGES_LOCATION+"kik.png"},costFactor:function(){return 10},priceAsFormattedString:function(a){return this._mKikForIAPs?"FREE!":"$"+(a*this.costFactor()/100-.01).toFixed(2)},formattedPriceForItem:function(){return"$"+(aPrice*this.costFactor()/100-.01).toFixed(2)},gameWasLaunched:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"Kik gameWasLaunched"),window.cards&&cards.browser&&window.TGE&&TGE.Game.GetInstance()&&(cards.browser.on("background",this.onBackground.bind(this)),cards.browser.on("foreground",this.onForeground.bind(this)),TGE.Button.DefaultVerticalPressOffset=4)},onBackground:function(){if(this._mSkipBackgroundEvent)return void(this._mSkipBackgroundEvent=!1);if("undefined"!=typeof window.TGE&&TGE.Game.GetInstance()){var a=TGE.Game.GetInstance();TGS.Debug.Log(TGS.Debug.LOG_INFO,"pausing the game and halting update loop"),TGE.Game.GetInstance().PauseGame(!0),a._mRAFID?(TGS.Debug.Log(TGS.Debug.LOG_INFO,"cancelling requestAnimationFrame..."),cancelAnimationFrame(a._mRAFID),a._mRAFID=null):TGS.Debug.Log(TGS.Debug.LOG_INFO,"requestAnimationFrame was already null?"),TGS.Debug.Log(TGS.Debug.LOG_INFO,"disabling updates..."),a._mUpdatingEnabled=!1}},onForeground:function(){if("undefined"!=typeof window.TGE&&TGE.Game.GetInstance()){var a=TGE.Game.GetInstance();null===a._mRAFID?(TGS.Debug.Log(TGS.Debug.LOG_INFO,"restarting requestAnimationFrame..."),a._mRAFID=requestAnimationFrame("undefined"!=typeof a.Update?a.Update.bind(a):a._update.bind(a))):TGS.Debug.Log(TGS.Debug.LOG_INFO,"requestAnimationFrame was already active?"),TGS.Debug.Log(TGS.Debug.LOG_INFO,"turning updating back on with a 30 frame delay"),a._mUpdatingEnabled=!0,a._mUpdateSkips=30}},initialize:function(){navigator.onLine===!1&&(TGS.Debug.Log(TGS.Debug.LOG_WARNING,"navigator.onLine is false - TGS going into OFFLINE mode"),TGS._sOnline=!1),window.cards&&cards.kik||TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Kik cards module was not loaded, or game is not being played in Kik Messenger");var a="landscape";window.cards&&cards.kik&&("undefined"!=typeof window.GameConfig&&GameConfig.ORIENTATION&&(a=GameConfig.ORIENTATION),cards.browser.setOrientationLock(a)),kik.browser.statusBar(!1),kik.browser.backlightTimeout(!1),this._mIsReady=!0,null!==this.onAdapterReady&&this.onAdapterReady.call()},connect:function(){if(window.cards&&cards.purchase){for(var a=[],b=TGS.Microtransactions.GetIAPProducts(),c=0;c<b.length;c++)b[c].partnerProductID&&a.push(b[c].partnerProductID);TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"requesting Kik IAP items: "+a.toString()),cards.purchase.init(a)}else TGS.Debug.Log(TGS.Debug.LOG_WARNING,"Kik IAP is unavailable");this.getLoginStatus()},loginUser:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"prompting user to link to their Kik account..."),this._mSkipBackgroundEvent=!0,cards.kik.getUser(this.onLinkToKik.bind(this,a))},onLinkToKik:function(a,b){return this._mSkipBackgroundEvent=!1,b?"string"!=typeof b.username||b.username.length<1?void TGS._LoginFailed(a):(this._mUsername=b.username,this._mAvatarURL=b.thumbnail,void this.userLoggedIn(a,b.username)):void TGS._LoginCanceled(a)},purchaseItem:function(a){if(this._mKikForIAPs)TGS.OverlayMessage({title:"Special Offer!",message:"To unlock this item for FREE just kik the game to a friend:",buttonText:"",buttonAction:this.kikToPurchaseCancelled.bind(this,a),button2Image:TGS._IMAGES_LOCATION+"kik_iap.png",button2Callback:this.kikToPurchase.bind(this,a)});else{if(!cards.purchase)return a.internalErrorMessage="Kik IAP unavailable",a.userErrorMessage="In-app purchases are not available on this version of Kik Messenger.",void TGS.Microtransactions._PartnerPurchaseFailed(a);var b=TGS.Microtransactions.GetIAPProduct(a.item.id);if(!b.partnerProductID)return a.internalErrorMessage="no Kik product id",a.userErrorMessage="Sorry, this item is not available on Kik Messenger yet.",void TGS.Microtransactions._PartnerPurchaseFailed(a);var c={transaction:a.transactionID};cards.purchase(b.partnerProductID,c,this.onPurchaseResponse.bind(this,a))}},onPurchaseResponse:function(a,b){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"onPurchaseResponse: "+JSON.stringify(b)),b?"string"!=typeof b.transactionId?(a.internalErrorMessage="Kik purchase failed - invalid transaction id",TGS.Microtransactions._PartnerPurchaseFailed(a)):(TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"transaction content: "+JSON.stringify(b.content)),a.partnerTransactionID=b.transactionId,TGS.Debug.Log(TGS.Debug.LOG_INFO,"Kik approved purchase of transaction "+a.transactionID),TGS.Microtransactions._PartnerPurchaseSuccessful(a)):(a.internalErrorMessage="Kik purchase failed - no transaction object",a.userErrorMessage="The transaction was not completed.",TGS.Microtransactions._PartnerPurchaseFailed(a))},kikToPurchase:function(a){var b="undefined"!=typeof window.GameConfig&&"string"==typeof window.GameConfig.TITLE?window.GameConfig.TITLE:null,c=b?b:"Check out this game!";cards.kik.send({title:c,text:"Check out this game I'm playing on Kik right now - it's awesome!"}),TGS.CloseMessageOverlay(),a.partnerTransactionID="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)}),TGS.Debug.Log(TGS.Debug.LOG_INFO,"user did a Kik-it to complete purchase of transaction "+a.transactionID),TGS.Microtransactions._PartnerPurchaseSuccessful(a)},kikToPurchaseCancelled:function(a){a.internalErrorMessage="user didn't kik",a.userErrorMessage="",TGS.Microtransactions._PartnerPurchaseFailed(a)},purchaseComplete:function(a){this._mKikForIAPs||cards.purchase.complete(a.partnerTransactionID)},challenge:function(a){cards.kik.send({title:a.title,text:a.message}),TGS.Analytics._logChallengeEvent("request sent")},share:function(a,b){return"kik"!=a?void TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Attempting to share to "+a+". Only kik is allowed."):void cards.kik.send({title:b.title,text:b.msg,pic:b.image})},getShareServices:function(){return[{id:"kik",title:"Kik Messenger",label:"Kik it"}]},showMoreGames:function(){cards.kik.open(TGS.MoreGamesURL())}},extend(TGS.Adapters.A0020,TGS.PartnerBridge);